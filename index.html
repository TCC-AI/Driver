<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配送資訊登錄系統</title>
    <style>
        /* (原有樣式不變) */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: "微軟正黑體", sans-serif; }
        body { background-color: #f5f5f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .container { background-color: white; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); padding: 30px; width: 100%; max-width: 500px; position: relative; }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        input:focus { outline: none; border-color: #4a90e2; box-shadow: 0 0 5px rgba(74,144,226,0.3); }
        button { background-color: #4a90e2; color: white; border: none; border-radius: 5px; padding: 12px 20px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #3a7bc8; }
        .button-group { display: flex; gap: 15px; }
        .button-group button { flex: 1; }
        #reset-btn { background-color: #e74c3c; }
        #reset-btn:hover { background-color: #c0392b; }
        .error-message { color: #e74c3c; margin-top: 15px; text-align: center; }
        .message { color: #2ecc71; margin-top: 15px; text-align: center; }
        .hidden { display: none; }
        #welcome-message { text-align: right; color: #4a90e2; font-weight: bold; margin-bottom: 10px; }
        input[type="number"] { -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .nav-tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #ddd; }
        .nav-tabs button { background-color: transparent; color: #555; border: none; border-bottom: 3px solid transparent; padding: 10px 15px; font-size: 16px; cursor: pointer; transition: all 0.3s; }
        .nav-tabs button.active { color: #4a90e2; border-bottom-color: #4a90e2; }
        .tab-content > div { display: none; }
        .tab-content > div.active { display: block; }
        .history-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .history-table th, .history-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .history-table th { background-color: #f2f2f2; position: sticky; top: 0; }
        .history-container { max-height: 300px; overflow-y: auto; margin-bottom: 20px; }
        .date-filter { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        .date-filter label { margin-bottom: 0; white-space: nowrap; }
        .date-filter input { flex: 1; }
        /* 下拉與彈窗 */
        .logout-dropdown { position: absolute; top: 50px; right: 30px; background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1000; overflow: hidden; min-width: 140px; }
        .logout-dropdown .dropdown-option { padding: 12px 15px; cursor: pointer; transition: background-color 0.3s; font-size: 14px; }
        .logout-dropdown .dropdown-option:hover { background-color: #f5f5f5; }
        .logout-dropdown .logout-opt { color: #ff3333; font-weight: bold; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; }
        .modal-content h3 { margin-bottom: 15px; }
        .modal-content .form-group { margin-bottom: 10px; }
        .modal-content .error-message { font-size: 14px; margin-top: 5px; }
    </style>
</head>
<body>
    <div id="login-container" class="container">
        <h1>配送資訊登錄系統</h1>
        <div class="form-group">
            <label for="username">帳號</label>
            <input type="text" id="username" placeholder="請輸入帳號">
        </div>
        <div class="form-group">
            <label for="password">密碼</label>
            <input type="password" id="password" placeholder="請輸入密碼">
        </div>
        <button id="login-btn">登入</button>
        <p id="login-error" class="error-message"></p>
    </div>

    <div id="delivery-container" class="container hidden">
        <div class="header-actions">
            <div id="welcome-message"></div>
            <button id="logoutButton" class="dropdown-btn">⋮</button>
        </div>

        <div class="nav-tabs">
            <button id="tab-form" class="active">配送登錄</button>
            <button id="tab-history">歷史記錄</button>
        </div>
        <div class="tab-content">
            <div id="form-content" class="active">
                <!-- ...表單內容不變... -->
            </div>
            <div id="history-content">
                <!-- ...歷史記錄內容不變... -->
            </div>
        </div>
    </div>

    <!-- 更改密碼彈窗 -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <h3>更改密碼</h3>
            <div class="form-group">
                <label>當前密碼</label>
                <input type="password" id="currentPassword">
            </div>
            <div class="form-group">
                <label>新密碼</label>
                <input type="password" id="newPassword">
            </div>
            <div class="form-group">
                <label>確認新密碼</label>
                <input type="password" id="confirmPassword">
            </div>
            <p id="passwordError" class="error-message hidden"></p>
            <div class="button-group">
                <button onclick="changePassword()">確定</button>
                <button onclick="closeChangePasswordModal()" id="cancelChange">取消</button>
            </div>
        </div>
    </div>

    <script>
        let userData = null;
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyLAmNwStgT_vGsvzK3hCx4Ne_lhk-Brb0HKDe4HPs-wVpSTUb_lT15LBhvKpUNo38w/exec';

        document.addEventListener('DOMContentLoaded', () => {
            // 維持原有事件綁定
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('submit-btn').addEventListener('click', handleSubmit);
            document.getElementById('reset-btn').addEventListener('click', resetForm);
            setupNumericInputs();
            document.getElementById('tab-form').addEventListener('click', () => switchTab('form'));
            document.getElementById('tab-history').addEventListener('click', () => switchTab('history'));
            document.getElementById('filter-btn').addEventListener('click', loadHistoryData);
            const today = new Date();
            document.getElementById('end-date').value = today.toISOString().split('T')[0];
            const lastWeek = new Date(); lastWeek.setDate(today.getDate() - 7);
            document.getElementById('start-date').value = lastWeek.toISOString().split('T')[0];
            document.getElementById('logoutButton').addEventListener('click', logoutUser);
        });

        // 切換下拉菜單
        function logoutUser() {
            const existing = document.querySelector('.logout-dropdown');
            if (existing) { existing.remove(); return; }
            const dropdown = document.createElement('div'); dropdown.className = 'logout-dropdown';
            const changeOpt = document.createElement('div'); changeOpt.className = 'dropdown-option'; changeOpt.textContent = '更改密碼';
            changeOpt.onclick = () => { showChangePasswordModal(); dropdown.remove(); };
            const logoutOpt = document.createElement('div'); logoutOpt.className = 'dropdown-option logout-opt'; logoutOpt.textContent = '登出系統';
            logoutOpt.onclick = () => { dropdown.remove(); performLogout(); };
            dropdown.append(changeOpt, logoutOpt);
            document.body.appendChild(dropdown);
            setTimeout(() => document.addEventListener('click', function docClick(e) {
                if (!dropdown.contains(e.target) && e.target.id !== 'logoutButton') {
                    dropdown.remove(); document.removeEventListener('click', docClick);
                }
            }), 0);
        }

        function performLogout() {
            document.getElementById('delivery-container').classList.add('hidden');
            document.getElementById('login-container').classList.remove('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('login-error').textContent = '';
            userData = null;
        }

        function showChangePasswordModal() {
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('passwordError').classList.add('hidden');
            document.getElementById('changePasswordModal').style.display = 'flex';
        }
        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'none';
        }

        function changePassword() {
            const cur = document.getElementById('currentPassword').value;
            const neu = document.getElementById('newPassword').value;
            const conf = document.getElementById('confirmPassword').value;
            const err = document.getElementById('passwordError');
            if (!cur||!neu||!conf) { err.textContent='請填寫所有欄位'; err.classList.remove('hidden'); return; }
            if (neu !== conf) { err.textContent='新密碼與確認密碼不符'; err.classList.remove('hidden'); return; }
            fetch(SCRIPT_URL, { method:'POST', body: JSON.stringify({ action:'resetPassword', username:userData.username, currentPassword:cur, newPassword:neu }) })
            .then(r=>r.json())
            .then(data=>{
                if (data.success) {
                    alert('密碼更改成功！請重新登入。'); closeChangePasswordModal(); performLogout();
                } else {
                    err.textContent = data.message || '密碼更改失敗'; err.classList.remove('hidden');
                }
            }).catch(e=>{ console.error(e); err.textContent='更改密碼時發生錯誤，請稍後再試'; err.classList.remove('hidden'); });
        }

        // 其餘函式 (handleLogin, handleSubmit, etc.) 保持不變
    </script>
</body>
</html>
